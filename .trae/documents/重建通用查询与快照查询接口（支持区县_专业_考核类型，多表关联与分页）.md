## 背景与目标
- 已移除原有 get_indicator_data 与 indicator_dashboard 接口，需要重新设计后端查询。
- 目标：在同一套查询能力下，准确支持按区县、专业、考核类型的多表关联筛选，解决“未筛选时显示不全、不能分页”的问题。

## 接口设计
- GET /api/v1/metrics/query
  - 用途：返回原始指标数据的分页列表（IndicatorData），支持组合筛选与排序。
  - 请求参数：
    - district_id、district_name（可选，二选一）
    - major_id（可选）
    - type_id（可选）
    - indicator_id、indicator_code（可选）
    - start_date、end_date（可选，YYYY-MM-DD）
    - page（默认1）、size（默认50，最大1000）、order_by（默认stat_date）、desc（默认true）
  - 响应：{ items: IndicatorDataOut[], total: number }

- GET /api/v1/metrics/snapshot
  - 用途：返回“每个指标×区县的最新一条数据”的分页列表，用于仪表盘快照视图。
  - 请求参数：同 /query（其中 start/end 不参与最新值判定，仅用于来源筛选）
  - 响应：{ items: IndicatorDataOut[], total: number }

## 服务层实现
- 新增：query_metrics(session, filters...)
  - 选择主体：select(IndicatorData) JOIN Indicator（始终联接）
  - 过滤：
    - 有效指标：Indicator.status == 1（统一默认）
    - 区县：district_id 或 district_name（按需）
    - 专业：Indicator.major_id == :major_id（按 ID）；若未来按名称，则 JOIN Major 并 LIKE
    - 类型：Indicator.type_id == :type_id（按 ID）；若未来按名称，则 JOIN EvaluationType 并 LIKE
    - 指标：indicator_id / indicator_code
    - 日期范围：IndicatorData.stat_date BETWEEN start_date/end_date
  - 统计总数：select(func.count()).select_from(已应用所有过滤的子查询)，避免 with_only_columns 导致统计不准
  - 排序与分页：在总数统计后应用 order_by + offset/limit

- 新增：latest_metrics(session, filters...)
  - 在包含上述过滤的基础语句上，使用窗口函数：row_number() over(partition by IndicatorData.indicator_id, IndicatorData.district_id order by stat_date desc)
  - 取 rn=1 作为“最新快照”；对该结果进行分页与总数统计（同样用子查询计数）

## 多表关联原则
- 按 ID 筛选时：直接使用 Indicator.major_id、Indicator.type_id 字段（不必额外 JOIN）
- 按名称筛选时：
  - 区县：JOIN District；专业：JOIN Major；类型：JOIN EvaluationType
- 始终 JOIN Indicator：统一应用 status=1，有利于分类约束与去重策略拓展

## 前端适配
- API 改成：/metrics/query 与 /metrics/snapshot（原 store 与分页控件不变，仅调整调用路径）
- 保持响应结构 items+total，不需修改分页组件逻辑

## 验证用例
- 未筛选：/metrics/query?page=1&size=20 → total≈2000+，items.length=20；翻页到 page=2 正常
- 区县筛选：district_id=任意 → total 与数据符合库中分布
- 专业/类型筛选：major_id/type_id → 结果准确且无跨分类重复
- 快照：/metrics/snapshot → 每个“指标×区县”仅最新一条

## 备注
- 若需支持按名称（major_name/type_name）筛选，可在接口中增设可选参数，并服务层按需 JOIN 对应维表进行 LIKE 过滤
- 若后续需要“按 indicator_code 去最新有效版本去重”的原子化查询，可在 snapshot 接口上扩展按 code 维度的窗口函数策略